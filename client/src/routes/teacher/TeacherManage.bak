import { useEffect, useMemo, useState } from 'react'
import { Link, useParams } from 'react-router-dom'
import api from '../../lib/api'

type Occ = { word: string; paragraphIndex: number; sentenceIndex: number; charStart?: number; charEnd?: number }

function splitSentences(text: string): string[] { const parts:string[]=[]; const re=/([^.!?]*[.!?])/g; let m:RegExpExecArray|null; while((m=re.exec(text))) parts.push(m[1].trim()); if(parts.length===0&&text.trim()) parts.push(text.trim()); return parts }

function renderTeacherParagraph(paragraph: string, paragraphIndex: number, occ: Occ[]) {
  let hi = 0;
  const bySentence = new Map<number, Occ[]>();
  for (const o of occ.filter(o=>o.paragraphIndex===paragraphIndex)) {
    const arr = bySentence.get(o.sentenceIndex) || [];
    arr.push(o); bySentence.set(o.sentenceIndex, arr);
  }
  const sentences = splitSentences(paragraph);
  const rendered: (JSX.Element|string)[] = [];
  for (let s = 0; s < sentences.length; s++) {
    const os = (bySentence.get(s) || []).slice().sort((a,b)=> (b.charStart||0) - (a.charStart||0));
    if (os.length === 0) { rendered.push(sentences[s]+' '); continue; }
    let cur: (JSX.Element|string)[] = [sentences[s]];
    for (const o of os) {
      const start = o.charStart ?? -1; const end = o.charEnd ?? -1;
      const next: (JSX.Element|string)[] = [];
      for (const chunk of cur) {
        if (typeof chunk !== 'string') { next.push(chunk); continue; }
        if (start >= 0 && end > start && end <= chunk.length) {
          const before = chunk.slice(0, start);
          const mid = chunk.slice(start, end);
          const after = chunk.slice(end);
          if (before) next.push(before);
          next.push(<span className="target-highlight" key={`hl-${paragraphIndex}-${s}-${hi++}`}>{mid}</span>);
          if (after) next.push(after);
        } else {
          const pattern = (o.word||'').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`\\b${pattern}\\b`, 'i');
          const m = re.exec(chunk);
          if (m) {
            const before = chunk.slice(0, m.index);
            const mid = chunk.slice(m.index, m.index + m[0].length);
            const after = chunk.slice(m.index + m[0].length);
            if (before) next.push(before);
            next.push(<span className="target-highlight" key={`hl-${paragraphIndex}-${s}-${hi++}`}>{mid}</span>);
            if (after) next.push(after);
          } else next.push(chunk);
        }
      }
      cur = next;
    }
    rendered.push(<span key={`${paragraphIndex}-${s}`}>{cur}</span>);
    rendered.push(' ');
  }
  return rendered;
}

function useWordsState(initial: string) {
  const [words, setWords] = useState(initial)
  const arr = useMemo(() => words.split(',').map(s => s.trim()).filter(Boolean).slice(0,15), [words])
  function toggle(w: string) { if (arr.includes(w)) setWords(arr.filter(x=>x!==w).join(', ')); else setWords([...arr, w].slice(0,15).join(', ')) }
  return { words, setWords, arr, toggle }
}

export default function TeacherManage() {
  const { id: expId } = useParams()
  const [meta, setMeta] = useState<{ title?: string; level?: string } | null>(null)
  const [suggestions, setSuggestions] = useState<string[]>([])
  const { words, setWords, arr, toggle } = useWordsState('')
  const wordsH = arr.slice(0, Math.ceil(arr.length/2))
  const wordsN = arr.slice(Math.ceil(arr.length/2))
  const [status, setStatus] = useState('')
  const [storyH, setStoryH] = useState<{ paragraphs: string[]; occ: Occ[] } | null>(null)
  const [storyN, setStoryN] = useState<{ paragraphs: string[]; occ: Occ[] } | null>(null)
  const [audioH, setAudioH] = useState<string>('')
  const [audioN, setAudioN] = useState<string>('')
  const [joinCode, setJoinCode] = useState<string | null>(null)
  const [jobStatus, setJobStatus] = useState<{ words?: string; s1?: string; s2?: string; tts1?: string; tts2?: string }>({ words: 'Not started', s1: 'Not started', s2: 'Not started', tts1: 'Not started', tts2: 'Not started' })
  const [gen, setGen] = useState<{ s1: boolean; tts1: boolean; s2: boolean; tts2: boolean }>({ s1: false, tts1: false, s2: false, tts2: false })
  const statusText = (s?: string) => (s === 'success' ? 'Success \u2713' : (s === 'pending' || s === 'running' || s === 'generating') ? 'Generating...' : s === 'error' ? 'Error \u2013 try again' : 'Not started')
  const [saved, setSaved] = useState(false)
  // Separate steps: no auto-TTS

  useEffect(() => { (async () => { try { const { data } = await api.get(`/api/experiments/${expId}`); setMeta({ title: data?.title, level: data?.level }); const existing = (data?.targetWords||[]) as string[]; setWords(existing.join(', ')); if (existing.length) setSaved(true); await refreshStories() } catch {} })() }, [expId])

  async function fetchSuggestions() {
    try {
      const { data } = await api.post('/api/jobs', { type: 'fetch_words', experimentId: expId });
      setJobStatus(s=>({ ...s, words: 'pending' }));
      const got = await api.post(`/api/experiments/${expId}/suggestions`).catch(()=>null);
      if (got?.data?.suggestions) setSuggestions(got.data.suggestions)
    } catch(e:any){ setStatus(e?.response?.data?.error || 'Error \u2013 try again to enqueue fetch words') }
  }
  async function saveWords() { try { await api.post(`/api/experiments/${expId}/target-words`, { targetWords: arr }); setStatus('Words saved'); setSaved(true) } catch(e:any){ setStatus(e?.response?.data?.error || 'Save Error \u2013 try again'); setSaved(false) } }
  async function refreshStories(){ try { const [h,n] = await Promise.all([ api.get(`/api/experiments/${expId}/story/1`).catch(()=>({ data:null } as any)), api.get(`/api/experiments/${expId}/story/2`).catch(()=>({ data:null } as any)) ]); setStoryH(h?.data?.paragraphs ? { paragraphs: h.data.paragraphs, occ: (h.data.targetOccurrences||[]) as Occ[] } : null); setStoryN(n?.data?.paragraphs ? { paragraphs: n.data.paragraphs, occ: (n.data.targetOccurrences||[]) as Occ[] } : null); const base = import.meta.env.VITE_API_BASE_URL || 'http://localhost:4000'; const hu = (h?.data?.ttsAudioUrl || `/static/audio/${expId}/1.mp3`); const nu = (n?.data?.ttsAudioUrl || `/static/audio/${expId}/2.mp3`); setAudioH(hu ? (hu.startsWith('/static')? `${base}${hu}` : hu) : ''); setAudioN(nu ? (nu.startsWith('/static')? `${base}${nu}` : nu) : ''); } catch {} }
  async function generateH(){
    try {
      setJobStatus(s=>({ ...s, s1: 'pending' })); setGen(g=>({ ...g, s1: true }))
      await api.post('/api/jobs', { type:'generate_story', experimentId: expId, storyLabel:'story1' });
    } catch(e:any){ setStatus(e?.response?.data?.error || 'Error \u2013 try again to enqueue Story 1') }
  }
  async function generateN(){
    try {
      setJobStatus(s=>({ ...s, s2: 'pending' })); setGen(g=>({ ...g, s2: true }))
      await api.post('/api/jobs', { type:'generate_story', experimentId: expId, storyLabel:'story2' });
    } catch(e:any){ setStatus(e?.response?.data?.error || 'Error \u2013 try again to enqueue Story 2') }
  }
  async function ttsOne(label: '1'|'2') {
    try {
      const storyLabel = label==='1'?'story1':'story2'
      if (label==='1') { setJobStatus(s=>({ ...s, tts1: 'pending' })); setGen(g=>({ ...g, tts1: true })) } else { setJobStatus(s=>({ ...s, tts2: 'pending' })); setGen(g=>({ ...g, tts2: true })) }
      await api.post('/api/jobs', { type:'generate_tts', experimentId: expId, storyLabel });
    } catch(e:any){ setStatus(e?.response?.data?.error || 'Error \u2013 try again to enqueue TTS') }
  }
  async function launch(condition: 'with-hints'|'without-hints'){ try { const { data } = await api.post(`/api/experiments/${expId}/launch`, { condition }); setJoinCode(data?.code||null); setStatus(`Launched (${condition}). Code: ${data?.code}`) } catch(e:any){ setStatus(e?.response?.data?.error || 'Launch Error \u2013 try again') } }

  useEffect(() => {
    const t = setInterval(async () => {
      try {
        const { data } = await api.get(`/api/jobs/experiment/${expId}/status`).catch(()=>({ data:null } as any))
        if (data) {
          const mapped = { words: data.words as string, s1: data.s1 as string, s2: data.s2 as string, tts1: data.tts1 as string, tts2: data.tts2 as string }
          setJobStatus(s => ({
            words: mapped.words || s.words,
            s1: mapped.s1 && mapped.s1 !== 'idle' ? mapped.s1 : s.s1,
            s2: mapped.s2 && mapped.s2 !== 'idle' ? mapped.s2 : s.s2,
            tts1: mapped.tts1 && mapped.tts1 !== 'idle' ? mapped.tts1 : s.tts1,
            tts2: mapped.tts2 && mapped.tts2 !== 'idle' ? mapped.tts2 : s.tts2,
          }))
          if (['success'].includes(mapped.s1) || ['success'].includes(mapped.s2) || ['success'].includes(mapped.words) || ['success'].includes(mapped.tts1) || ['success'].includes(mapped.tts2)) { await refreshStories() }
          if (gen.s1 && (mapped.s1==='success' || mapped.s1==='error')) setGen(g=>({ ...g, s1: false }))
          if (gen.s2 && (mapped.s2==='success' || mapped.s2==='error')) setGen(g=>({ ...g, s2: false }))
          if (gen.tts1 && (mapped.tts1==='success' || mapped.tts1==='error')) setGen(g=>({ ...g, tts1: false }))
          if (gen.tts2 && (mapped.tts2==='success' || mapped.tts2==='error')) setGen(g=>({ ...g, tts2: false }))
        }
      } catch {}
    }, 1500)
    return () => clearInterval(t)
  }, [expId, gen])

  const readyToLaunch = (jobStatus.s1==='success' && jobStatus.tts1==='success' && jobStatus.s2==='success' && jobStatus.tts2==='success')

  return (
    <div className="container py-6">
      <div className="mb-3 text-xs text-gray-600"><Link to="/teacher">â† Back</Link></div>
      <h1 className="text-xl font-semibold mb-2">Manage Experiment</h1>
      <div className="text-sm text-gray-700 mb-4">{meta?.title} Â· Level {meta?.level || 'B1'}</div>

      <div className="space-y-4 border rounded p-3">
        <div className={`space-y-2 step ${saved ? 'done' : ''}`} data-step="1">
          <div className="font-medium step-title">Fetch suggestions and Save words</div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick={fetchSuggestions}>Fetch</button>
            <span className="text-xs text-gray-600">{statusText(jobStatus.words)}</span>
          </div>
          {!!suggestions.length && (
            <div className="flex flex-wrap gap-2">
              {suggestions.map((w, i) => (
                <button key={i} className={`px-2 py-1 rounded border ${arr.includes(w) ? 'bg-blue-50 border-blue-400' : ''}`} onClick={()=>toggle(w)}>{w}</button>
              ))}
            </div>
          )}
          <label className="text-xs">Words (comma separated)</label>
          <input className="input w-full" value={words} onChange={e=>setWords(e.target.value)} placeholder="e.g. apple, river, music" />
          <div className="text-xs text-gray-600">Story 1 uses: <span className="font-medium">{wordsH.join(', ') || '-'}</span></div>
          <div className="text-xs text-gray-600">Story 2 uses: <span className="font-medium">{wordsN.join(', ') || '-'}</span></div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick={saveWords} disabled={!arr.length}>{'Save selected words'}</button>
            <span className="text-xs text-gray-600">{status || (!arr.length ? 'Not started' : '')}</span>
          </div>
        </div>

        <div className={`space-y-2 step ${(jobStatus.s1==='success' && jobStatus.tts1==='success') ? 'done' : ''}`} data-step="3">
          <div className="font-medium step-title">Generate Story 1 and TTS</div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick={generateH} disabled={!saved || gen.s1 || jobStatus.s1==='pending'||jobStatus.s1==='running'}>{gen.s1 ? 'Generatingâ€¦' : 'Generate Story 1'}</button>
            <span className="text-xs text-gray-600">
              {jobStatus.s1==='pending'||jobStatus.s1==='running' ? 'Generating...' : jobStatus.s1==='success' ? (
                <>
                  Success \u2713{' '}
                  <button className="text-blue-600 underline" onClick={generateH}>Regenerate</button>
                </>
              ) : jobStatus.s1==='error' ? 'Error \u2013 try again' : 'Not started'}
            </span>
          </div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick={()=>ttsOne('1')} disabled={jobStatus.s1!=='success' || gen.tts1 || jobStatus.tts1==='pending'||jobStatus.tts1==='running'}>{gen.tts1 ? 'Generatingâ€¦' : 'Generate TTS 1'}</button>
            <span className="text-xs text-gray-600">
              {jobStatus.tts1==='pending'||jobStatus.tts1==='running' ? 'Generating...' : jobStatus.tts1==='success' ? (
                <>
                  Success \u2713{' '}
                  <button className="text-blue-600 underline" onClick={()=>ttsOne('1')}>Regenerate</button>
                </>
              ) : jobStatus.tts1==='error' ? 'Error \u2013 try again' : 'Not started'}
            </span>
          </div>
          <div className="text-xs text-gray-600">Highlighted words are your selected target words.</div>
          <div>
            {storyH ? storyH.paragraphs.map((p,i)=>(<p key={i} className="mb-2 leading-7">{renderTeacherParagraph(p, i, storyH.occ)}</p>)) : <div className="text-xs text-gray-500">No story yet.</div>}
            {audioH && <audio id={`audio-1-${expId}`} controls src={audioH} className="mt-1 w-full" />}
          </div>
        </div>

        <div className={`space-y-2 step ${(jobStatus.s2==='success' && jobStatus.tts2==='success') ? 'done' : ''}`} data-step="4">
          <div className="font-medium step-title">Generate Story 2 and TTS</div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick={generateN} disabled={!(jobStatus.s1==='success' && jobStatus.tts1==='success') || gen.s2 || jobStatus.s2==='pending'||jobStatus.s2==='running'}>{gen.s2 ? 'Generatingâ€¦' : 'Generate Story 2'}</button>
            <span className="text-xs text-gray-600">
              {jobStatus.s2==='pending'||jobStatus.s2==='running' ? 'Generating...' : jobStatus.s2==='success' ? (
                <>
                  Success \u2713{' '}
                  <button className="text-blue-600 underline" onClick={generateN}>Regenerate</button>
                </>
              ) : jobStatus.s2==='error' ? 'Error \u2013 try again' : 'Not started'}
            </span>
          </div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick={()=>ttsOne('2')} disabled={jobStatus.s2!=='success' || gen.tts2 || jobStatus.tts2==='pending'||jobStatus.tts2==='running'}>{gen.tts2 ? 'Generatingâ€¦' : 'Generate TTS 2'}</button>
            <span className="text-xs text-gray-600">
              {jobStatus.tts2==='pending'||jobStatus.tts2==='running' ? 'Generating...' : jobStatus.tts2==='success' ? (
                <>
                  Success \u2713{' '}
                  <button className="text-blue-600 underline" onClick={()=>ttsOne('2')}>Regenerate</button>
                </>
              ) : jobStatus.tts2==='error' ? 'Error \u2013 try again' : 'Not started'}
            </span>
          </div>
          <div>
            {storyN ? storyN.paragraphs.map((p,i)=>(<p key={i} className="mb-2 leading-7">{renderTeacherParagraph(p, i, storyN.occ)}</p>)) : <div className="text-xs text-gray-500">No story yet.</div>}
            {audioN && <audio id={`audio-2-${expId}`} controls src={audioN} className="mt-1 w-full" />}
          </div>
        </div>

        <div className="mt-3">
          <div className="font-medium mb-1">Launch</div>
          <div className="flex gap-2 items-center flex-wrap">
            <span className="text-xs text-gray-600 mr-2">{readyToLaunch ? 'Ready to launch \u2713' : 'Complete steps 3 and 4 first'}</span>
            <button className="btn primary" disabled={!readyToLaunch} onClick={()=>launch('with-hints')}>Launch (Hints enabled)</button>
            <button className="btn" disabled={!readyToLaunch} onClick={()=>launch('without-hints')}>Launch (Hints disabled)</button>
            {joinCode && <div className="text-xs">Join Code: <span className="font-mono">{joinCode}</span></div>}
          </div>
        </div>
      </div>
    </div>
  )
}
